from pathlib import Path
html = r"""<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Mpruebas</title>

  <style>
    :root{
      --bg:#fff4fb;
      --panel:#ffffff;
      --panel2:rgba(255,255,255,.78);
      --text:#241b2a;
      --muted:#7a6b78;

      --pink:#ff4fb7;
      --purple:#a855f7;
      --rose:#fb7185;

      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --border:rgba(36, 20, 40, .10);
      --shadow: 0 16px 40px rgba(20, 10, 25, .10);
      --shadow2: 0 10px 26px rgba(20, 10, 25, .07);

      --radius: 22px;
      --radius2: 16px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;

      --focus: 0 0 0 4px rgba(255,79,183,.15);

      /* tama√±o base del recibo (MOSTRADOR) */
      --receiptW: 360px;

      /* tama√±o configurable para ENVIO (solo aplica cuando tipo venta = ENVIO y se exporta o se previsualiza) */
      --shipReceiptW: 360px;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      overflow-x:hidden;

      background:
        radial-gradient(900px 650px at 18% 8%, rgba(255,79,183,.20), transparent 55%),
        radial-gradient(800px 520px at 85% 5%, rgba(168,85,247,.20), transparent 60%),
        radial-gradient(700px 520px at 70% 90%, rgba(251,113,133,.16), transparent 55%),
        var(--bg);
    }

    .sparkle{
      position:fixed;
      inset:0;
      pointer-events:none;
      opacity:.35;
      mix-blend-mode:multiply;
      background-image:
        radial-gradient(circle at 12% 18%, rgba(255,79,183,.22) 0 2px, transparent 3px),
        radial-gradient(circle at 84% 22%, rgba(168,85,247,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 62% 78%, rgba(251,113,133,.18) 0 2px, transparent 3px),
        radial-gradient(circle at 28% 72%, rgba(255,79,183,.14) 0 2px, transparent 3px);
      animation: drift 12s ease-in-out infinite alternate;
      filter: blur(.2px);
    }
    @keyframes drift{
      from{ transform: translate3d(0,0,0) scale(1); }
      to{ transform: translate3d(-10px, 8px, 0) scale(1.02); }
    }

    .app{
      max-width: 1240px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
    }

    .sidebar{
      position: sticky;
      top: 14px;
      align-self: start;
      height: calc(100vh - 28px);
      background: linear-gradient(180deg, rgba(255,255,255,.92) 0%, rgba(255,247,252,.92) 100%);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow:auto;
      animation: pop .35s ease-out both;
    }
    @keyframes pop{
      from{ transform: translateY(8px); opacity:0; }
      to{ transform: translateY(0); opacity:1; }
    }

    .brand{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 10px 10px 14px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }
    .brand h1{
      font-size: 15px;
      margin:0;
      line-height:1.15;
      letter-spacing:.2px;
      font-weight: 1000;
    }
    .brand small{display:block;color:var(--muted); font-weight:800; margin-top:2px}

    .hamburger{
      width:42px;height:42px;border-radius:16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      box-shadow: 0 10px 22px rgba(17,10,20,.07);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .hamburger:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(17,10,20,.10); }
    .hamburger:active{ transform: translateY(0); }
    .burger{ width:18px;height:12px; position:relative; }
    .burger span{
      position:absolute; left:0; right:0;
      height:2px; border-radius:999px;
      background: linear-gradient(90deg, var(--pink), var(--purple));
    }
    .burger span:nth-child(1){top:0}
    .burger span:nth-child(2){top:5px}
    .burger span:nth-child(3){bottom:0}

    .nav{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:12px;
    }
    .nav button{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      box-shadow: var(--shadow2);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .nav button:hover{
      transform: translateY(-1px);
      box-shadow: 0 16px 30px rgba(20,10,25,.09);
    }
    .nav button .tag{
      font-weight:1000;
      font-size:12px;
      padding: 4px 10px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(255,79,183,.14), rgba(168,85,247,.14));
      color: #7b2fb4;
      border:1px solid rgba(168,85,247,.18);
      white-space:nowrap;
    }
    .nav button.active{
      border-color: rgba(255,79,183,.55);
      box-shadow: 0 18px 34px rgba(255,79,183,.18);
      background: linear-gradient(180deg, #fff 0%, #fff1fa 100%);
    }

    .sidecard{
      margin-top:14px;
      padding:12px;
      border-radius: var(--radius);
      border:1px dashed rgba(255,79,183,.38);
      background: rgba(255,255,255,.84);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-weight:1000;
      color:#7b2fb4;
      background: rgba(168,85,247,.12);
      border:1px solid rgba(168,85,247,.25);
      padding: 6px 10px;
      border-radius:999px;
    }
    .sidecard .row{
      display:flex; justify-content:space-between; gap:10px; margin:8px 0;
      color:var(--muted); font-weight:800;
    }
    .sidecard .row b{color:var(--text)}

    .main{
      min-height: calc(100vh - 36px);
      background: var(--panel2);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      overflow: visible;
      animation: pop .35s ease-out both;
      max-width:100%;
    }

    .topbar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 6px 6px 12px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 14px;
    }
    .title{ display:flex; flex-direction:column; gap:2px; }
    .title h2{margin:0;font-size:18px}
    .title p{margin:0;color:var(--muted);font-weight:800;font-size:13px}

    .actions{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }

    .btn{
      border:none;
      cursor:pointer;
      font-weight:1000;
      padding: 11px 14px;
      border-radius: 16px;
      background:#fff;
      border:1px solid var(--border);
      box-shadow: 0 10px 22px rgba(17,10,20,.06);
      color:var(--text);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 16px 30px rgba(17,10,20,.09); }
    .btn:active{ transform: translateY(0); }
    .btn.small{ padding:9px 12px; border-radius:14px; font-weight:1000; }

    .btn.primary{
      background: linear-gradient(90deg, var(--pink), var(--purple));
      color:white;
      border:none;
      box-shadow: 0 16px 34px rgba(255,79,183,.26);
    }
    .btn.ok{
      background: linear-gradient(90deg, #22c55e, #16a34a);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(34,197,94,.22);
    }
    .btn.danger{
      background: linear-gradient(90deg, #ef4444, #b91c1c);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(239,68,68,.22);
    }
    .btn.warn{
      background: linear-gradient(90deg, #f59e0b, #d97706);
      color:white;border:none;
      box-shadow: 0 16px 34px rgba(245,158,11,.22);
    }

    .grid{
      display:grid;
      grid-template-columns: minmax(0, 1.15fr) minmax(0, 0.85fr);
      gap: 14px;
      margin-top: 14px;
    }

    .card, .field, .rowflex, .table{ min-width:0; }

    .card{
      background: rgba(255,255,255,.90);
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      overflow:hidden;
      position:relative;
    }
    .card::after{
      content:"";
      position:absolute;
      inset:-2px;
      pointer-events:none;
      opacity:0;
      border-radius: calc(var(--radius) + 2px);
      background: radial-gradient(700px 180px at 20% 0%, rgba(255,79,183,.12), transparent 50%),
                  radial-gradient(700px 180px at 80% 0%, rgba(168,85,247,.12), transparent 50%);
      transition: opacity .22s ease;
    }
    .card:hover::after{ opacity:1; }

    .card h3{margin:0 0 10px 0; font-size:15px; font-weight:1000}
    .muted{color:var(--muted); font-weight:800; font-size:13px}

    .form{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:1000;
      letter-spacing:.2px;
    }
    .field input, .field select, .field textarea{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
      outline:none;
      font-weight:900;
      color:var(--text);
      min-width:0;
      transition: box-shadow .18s ease, border-color .18s ease, transform .18s ease;
    }
    .field input:focus, .field select:focus, .field textarea:focus{
      border-color: rgba(255,79,183,.55);
      box-shadow: var(--focus);
    }

    .field.full{grid-column:1 / -1}

    .rowflex{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .rowflex .grow{ flex:1; }

    .table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--border);
      background:#fff;
    }
    .table th, .table td{
      padding:10px 10px;
      border-bottom:1px solid var(--border);
      text-align:left;
      font-weight:900;
      font-size:13px;
      vertical-align:top;
    }
    .table th{
      background: rgba(255,79,183,.09);
      color:#6b1f5b;
    }
    .table td small{color:var(--muted); font-weight:900}
    .table tr:last-child td{border-bottom:none}

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      padding:12px;
      border-radius: var(--radius2);
      border:1px solid var(--border);
      background: rgba(255,255,255,.92);
      box-shadow: 0 10px 22px rgba(17,10,20,.05);
    }
    .kpi .label{ color:var(--muted); font-weight:1000; font-size:12px }
    .kpi .value{ font-size:18px; font-weight:1100; margin-top:4px }
    .kpi .value span{ font-size:12px; color:var(--muted); font-weight:1000 }

    .hide{ display:none !important; }

    .receiptWrap{ display:flex; gap:12px; flex-wrap:wrap; }
    .receipt{
      width: var(--receiptW);
      background: #ffffff;
      border:1px solid rgba(0,0,0,.08);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 34px rgba(0,0,0,.11);
      transform-origin: top center;
      animation: floatIn .35s ease-out both;
      position:relative;
    }
    .receipt.ship{
      width: var(--shipReceiptW);
    }
    .cornerLogo{
      position:absolute;
      top:10px;
      right:10px;
      width:52px;
      height:52px;
      object-fit:contain;
      border-radius:14px;
      background:#fff;
      border:1px solid rgba(0,0,0,.06);
      padding:4px;
    }
    @keyframes floatIn{
      from{ transform: translateY(10px) scale(.98); opacity:0; }
      to{ transform: translateY(0) scale(1); opacity:1; }
    }
    .receipt .logo{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding-bottom:10px;
      border-bottom:1px dashed rgba(0,0,0,.12);
      margin-bottom:10px;
      padding-right:60px;
    }
    .receipt .logo b{ font-size:14px; letter-spacing:.3px; }
    .receipt .logo small{ display:block; color:#666; font-weight:900 }
    .receipt .line{ display:flex; justify-content:space-between; gap:10px; font-weight:1000; font-size:12px; margin:6px 0 }
    .receipt .hr{ height:1px; background:rgba(0,0,0,.08); margin:10px 0 }
    .receipt .big{ font-size:16px; font-weight:1200; display:flex; justify-content:space-between; margin-top:10px; }
    .receipt .foot{ margin-top:10px; font-size:11px; color:#666; font-weight:900 }

    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 980px){
      .app{ grid-template-columns: 1fr; }
      .sidebar{ position:relative; height:auto; }
      .receipt{ width:100%; }
    }

    body.capture-mode .sparkle{ display:none !important; }
    body.capture-mode #receiptBox,
    body.capture-mode #closeBox{
      opacity: 1 !important;
      filter: none !important;
      transform: none !important;
    }

  </style>
</head>
<body>
  <div class="sparkle"></div>

  <div class="app">
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div>
          <h1>MYT ONLINE <small>ATLANTIC PLAZA</small></h1>
        </div>
        <button class="hamburger" id="btnToggle" title="Men√∫">
          <div class="burger"><span></span><span></span><span></span></div>
        </button>
      </div>

      <div class="nav" id="nav">
        <button class="active" data-view="pos"><span>üßæ Cobro (POS)</span><span class="tag">VENTA</span></button>
        <button data-view="shipments"><span>üöö Env√≠os pendientes</span><span class="tag">PEND</span></button>
        <button data-view="clients"><span>üë©‚Äçüíº Clientes</span><span class="tag">DB</span></button>
        <button data-view="reports"><span>üìä Reportes</span><span class="tag">D/W/M</span></button>
        <button data-view="products"><span>üß∑ Productos</span><span class="tag">SKU</span></button>
        <button data-view="inventory"><span>üì¶ Inventarios</span><span class="tag">STOCK</span></button>
        <button data-view="close"><span>üßæ Cierre</span><span class="tag">D√çA</span></button>
        <button data-view="settings"><span>‚öôÔ∏è Ajustes</span><span class="tag">LOCAL</span></button>
      </div>

      <div class="sidecard">
        <div class="pill">üíó TUS VENTAS HOY</div>
        <div class="row"><span>Clientes</span><b id="kClients">0</b></div>
        <div class="row"><span>Productos</span><b id="kProducts">0</b></div>
        <div class="row"><span>Ventas (hoy)</span><b id="kSalesToday">0</b></div>
        <div class="row"><span>Total (hoy)</span><b id="kTotalToday">Q0.00</b></div>
        <div class="muted" style="margin-top:10px">
          Tip: usa <b>Escanear</b> y pasa el lector. (F2 enfoca el campo)
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <div class="title">
          <h2 id="viewTitle">DASH PRINCIPAL</h2>
          <p id="viewSub">Soporte tecnico tel: 58140-621</p>
        </div>
        <div class="actions">
          <button class="btn small" id="btnBackup">Exportar JSON</button>
          <button class="btn small" id="btnRestore">Importar JSON</button>
        </div>
      </div>

      <!-- POS VIEW -->
      <section id="view-pos">
        <div class="grid">
          <div class="card">
            <h3>üßæ Venta</h3>

            <div class="form" style="margin-bottom:10px">
              <div class="field full">
                <label>Escanear c√≥digo de barras (SKU / C√≥digo)</label>
                <div class="rowflex">
                  <input id="scanInput" class="grow" inputmode="text" placeholder="ESCANEE EL CODIGO DE BARRAS" autocomplete="off" />
                  <button class="btn primary" id="btnScan">Escanear</button>
                </div>
                <div class="muted">.</div>
              </div>

              <div class="field">
                <label>Cantidad</label>
                <input id="qtyInput" type="number" min="1" value="1"/>
              </div>
              <div class="field">
                <label>Buscar producto (por nombre)</label>
                <input id="productSearch" placeholder="Ej: blusa, jeans..." />
              </div>

              <div class="field full">
                <label>Productos encontrados</label>
                <div class="rowflex">
                  <select id="productPicker" class="grow"></select>
                  <button class="btn" id="btnAddPicked">Agregar</button>
                </div>
              </div>
            </div>

            <table class="table" id="cartTable">
              <thead>
                <tr>
                  <th style="width:70px">Cant</th>
                  <th>Producto</th>
                  <th style="width:110px">Precio</th>
                  <th style="width:110px">Total</th>
                  <th style="width:110px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="cartBody"></tbody>
            </table>

            <div class="totals">
              <div class="kpi">
                <div class="label">Subtotal</div>
                <div class="value" id="subTotal">Q0.00</div>
              </div>
              <div class="kpi">
                <div class="label">Total</div>
                <div class="value" id="grandTotal">Q0.00 <span>(Q)</span></div>
              </div>
            </div>

            <div class="muted" style="margin-top:8px">
              Descuento aplicado: <b id="discTotal">Q0.00</b>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üí∏ Descuento</h3>
              <div class="rowflex">
                <select id="discType" class="grow">
                  <option value="NONE">SIN DESCUENTO</option>
                  <option value="Q">DESCUENTO (Q)</option>
                  <option value="PCT">DESCUENTO (%)</option>
                </select>
                <input id="discValue" type="number" min="0" step="0.01" value="0" style="max-width:160px" />
                <button class="btn" id="btnApplyDisc">Aplicar</button>
                <button class="btn danger" id="btnClearDisc">Quitar</button>
              </div>
              <div class="muted" style="margin-top:8px">
                El descuento se refleja en el ticket/PDF/PNG y el texto de WhatsApp.
              </div>
            </div>

            <div class="rowflex" style="margin-top:12px">
              <button class="btn" id="btnClearCart">Limpiar</button>
              <button class="btn ok" id="btnCheckout">Cobrar</button>
            </div>

            <div class="muted" style="margin-top:10px">
              *Si eliges <b>ENV√çO</b>, es obligatorio registrar/buscar cliente por tel√©fono.
            </div>
          </div>

          <div class="card">
            <h3>üí≥ Pago + Cliente</h3>

            <div class="form">
              <div class="field">
                <label>Forma de pago</label>
                <select id="payMethod">
                  <option value="EFECTIVO">EFECTIVO</option>
                  <option value="TARJETA">TARJETA</option>
                  <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                </select>
              </div>

              <div class="field">
                <label>Tipo de venta</label>
                <select id="saleType">
                  <option value="MOSTRADOR">MOSTRADOR</option>
                  <option value="ENVIO">ENV√çO</option>
                </select>
              </div>

              <div class="field full">
                <label>Tel√©fono (para buscar/crear cliente)</label>
                <div class="rowflex">
                  <input id="cPhone" class="grow" placeholder="Ej: 5555-5555" />
                  <button class="btn" id="btnFindClient">Buscar</button>
                </div>
                <div class="muted">En <b>ENV√çO</b> es obligatorio tener cliente.</div>
              </div>

              <div class="field">
                <label>Nombres</label>
                <input id="cNames" placeholder="Ej: Karina"/>
              </div>
              <div class="field">
                <label>Apellidos</label>
                <input id="cLast" placeholder="Ej: L√≥pez"/>
              </div>

              <div class="field full">
                <label>Direcci√≥n</label>
                <textarea id="cAddr" rows="3" placeholder="Ej: Col. X, casa #, zona..., referencias..."></textarea>
              </div>

              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveClient">Guardar cliente</button>
                  <button class="btn" id="btnUseWalkIn">Venta sin cliente</button>
                </div>
                <div class="muted">‚ÄúVenta sin cliente‚Äù solo aplica para MOSTRADOR.</div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üßæ Comprobante</h3>
              <div class="rowflex">
                <button class="btn" id="btnCopyReceipt">Copiar texto</button>
                <button class="btn" id="btnPDF">PDF</button>
                <button class="btn" id="btnDownloadReceipt">PNG</button>
                <button class="btn primary" id="btnWhatsApp">WhatsApp</button>
              </div>
              <div class="muted" style="margin-top:10px">
                PDF abre impresi√≥n (Guardar como PDF). WhatsApp abre texto listo.
              </div>
            </div>

            <div class="receiptWrap" style="margin-top:12px">
              <div class="receipt" id="receiptBox">
                <img class="cornerLogo" src="LOGO1.png" alt="Logo" />
                <div class="logo">
                  <div>
                    <b id="rShop">Tienda de Ropa</b>
                    <small id="rMeta">Recibo ‚Ä¢ Offline</small>
                  </div>
                  <div style="text-align:right">
                    <b id="rNo">#000001</b>
                    <small id="rDate">‚Äî</small>
                  </div>
                </div>

                <div class="line"><span>Cliente</span><span id="rClient">MOSTRADOR</span></div>
                <div class="line"><span>Tel√©fono</span><span id="rPhone">‚Äî</span></div>
                <div class="line"><span>Direcci√≥n</span><span id="rAddr">‚Äî</span></div>
                <div class="hr"></div>

                <div id="rItems"></div>

                <div class="hr"></div>
                <div class="line"><span>Subtotal</span><span id="rSub">Q0.00</span></div>
                <div class="line"><span>Descuento</span><span id="rDisc">Q0.00</span></div>
                <div class="line"><span>Pago</span><span id="rPay">EFECTIVO</span></div>
                <div class="big"><span>Total</span><span id="rTotal">Q0.00</span></div>
                <div class="foot">¬°Gracias por tu compra! üíó</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- SHIPMENTS VIEW -->
      <section id="view-shipments" class="hide">
        <div class="card">
          <h3>üöö Env√≠os pendientes de pago</h3>
          <div class="rowflex">
            <input id="shipSearch" class="grow" placeholder="Buscar por tel√©fono, nombre o #env√≠o..."/>
            <select id="shipFilter" style="max-width:210px">
              <option value="PENDIENTE">Solo pendientes</option>
              <option value="TODOS">Todos (pendientes + pagados)</option>
              <option value="PAGADO">Solo pagados</option>
            </select>
            <button class="btn" id="btnShipRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">
            Los env√≠os <b>PENDIENTE</b> no descuentan stock ni cuentan como venta hasta que los marques como <b>PAGADO</b>.
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                  <th>Estatus</th>
                  <th style="width:250px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="shipBody"></tbody>
            </table>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>üì¶ Detalle del env√≠o seleccionado</h3>
          <div class="muted">Selecciona un env√≠o en la tabla para ver su detalle y exportar comprobante.</div>

          <div class="rowflex" style="margin-top:10px">
            <button class="btn" id="btnShipCopy">Copiar texto</button>
            <button class="btn" id="btnShipPDF">PDF</button>
            <button class="btn" id="btnShipPNG">PNG</button>
            <button class="btn primary" id="btnShipWA">WhatsApp</button>
          </div>

          <div class="receiptWrap" style="margin-top:12px">
            <div class="receipt" id="shipReceiptBox">
              <img class="cornerLogo" src="LOGO1.png" alt="Logo" />
              <div class="logo">
                <div>
                  <b id="srShop">Tienda de Ropa</b>
                  <small id="srMeta">Env√≠o ‚Ä¢ Pendiente</small>
                </div>
                <div style="text-align:right">
                  <b id="srNo">#ENV-000001</b>
                  <small id="srDate">‚Äî</small>
                </div>
              </div>

              <div class="line"><span>Cliente</span><span id="srClient">‚Äî</span></div>
              <div class="line"><span>Tel√©fono</span><span id="srPhone">‚Äî</span></div>
              <div class="line"><span>Direcci√≥n</span><span id="srAddr">‚Äî</span></div>
              <div class="hr"></div>

              <div id="srItems"></div>

              <div class="hr"></div>
              <div class="line"><span>Subtotal</span><span id="srSub">Q0.00</span></div>
              <div class="line"><span>Descuento</span><span id="srDisc">Q0.00</span></div>
              <div class="line"><span>Pago</span><span id="srPay">‚Äî</span></div>
              <div class="big"><span>Total</span><span id="srTotal">Q0.00</span></div>
              <div class="foot" id="srFoot">Env√≠o en espera ‚è≥</div>
            </div>
          </div>
        </div>
      </section>

      <!-- CLIENTS VIEW -->
      <section id="view-clients" class="hide">
        <div class="card">
          <h3>üë©‚Äçüíº Clientes (base de datos local)</h3>
          <div class="rowflex">
            <input id="clientSearch" class="grow" placeholder="Buscar por tel√©fono o nombre..."/>
            <button class="btn" id="btnClientRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">Tel√©fono es el identificador. Se guarda en tu navegador (IndexedDB).</div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Tel√©fono</th>
                  <th>Nombre</th>
                  <th>Direcci√≥n</th>
                  <th style="width:140px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="clientsBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- REPORTS VIEW -->
      <section id="view-reports" class="hide">
        <div class="card">
          <h3>üìä Reportes (Diario / Semanal / Mensual)</h3>

          <div class="rowflex">
            <button class="btn" id="btnRepDaily">Hoy</button>
            <button class="btn" id="btnRepWeekly">Semana</button>
            <button class="btn" id="btnRepMonthly">Mes</button>
          </div>

          <div class="totals" style="margin-top:12px">
            <div class="kpi">
              <div class="label">Ventas</div>
              <div class="value" id="repCount">0</div>
            </div>
            <div class="kpi">
              <div class="label">Total</div>
              <div class="value" id="repTotal">Q0.00</div>
            </div>
          </div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Pago</th>
                  <th>Total</th>
                  <th style="width:160px">Acci√≥n</th>
                </tr>
              </thead>
              <tbody id="salesBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRODUCTS VIEW -->
      <section id="view-products" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üß∑ Productos (SKU / C√≥digo)</h3>
            <div class="form">
              <div class="field">
                <label>C√≥digo (SKU / Barras)</label>
                <input id="pCode" placeholder="Ej: 7501234567890"/>
              </div>
              <div class="field">
                <label>Nombre</label>
                <input id="pName" placeholder="Ej: Blusa rosa"/>
              </div>
              <div class="field">
                <label>Precio (Q)</label>
                <input id="pPrice" type="number" min="0" step="0.01" placeholder="Ej: 125"/>
              </div>
              <div class="field">
                <label>Stock</label>
                <input id="pStock" type="number" min="0" step="1" placeholder="Ej: 10"/>
              </div>
              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnSaveProduct">Guardar producto</button>
                </div>
                <div class="muted">Puedes agregar tus productos manualmente con c√≥digo, nombre, precio y stock.</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üì¶ Lista de productos</h3>
            <div class="rowflex">
              <input id="prodSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..."/>
              <button class="btn" id="btnProdRefresh">Refrescar</button>
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>C√≥digo</th>
                    <th>Producto</th>
                    <th>Precio</th>
                    <th>Stock</th>
                    <th style="width:140px">Acci√≥n</th>
                  </tr>
                </thead>
                <tbody id="productsBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>

      <!-- INVENTORY VIEW -->
      <section id="view-inventory" class="hide">
        <div class="card">
          <h3>üì¶ Inventarios (Stock actual)</h3>
          <div class="rowflex">
            <input id="invSearch" class="grow" placeholder="Buscar por c√≥digo o nombre..."/>
            <button class="btn" id="btnInvRefresh">Refrescar</button>
          </div>
          <div class="muted" style="margin-top:8px">Muestra el stock actual. Se descuenta autom√°ticamente al cobrar.</div>

          <div style="margin-top:12px; overflow:auto">
            <table class="table">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Producto</th>
                  <th>Precio</th>
                  <th>Stock</th>
                </tr>
              </thead>
              <tbody id="invBody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- CLOSE VIEW -->
      <section id="view-close" class="hide">
        <div class="grid">
          <div class="card">
            <h3>üßæ Cierre de ventas (por turno / rango)</h3>

            <div class="form">
              <div class="field">
                <label>Fecha del cierre</label>
                <input id="closeDate" type="date" />
              </div>
              <div class="field">
                <label>Nombre/Turno (opcional)</label>
                <input id="closeName" placeholder="Ej: Turno ma√±ana, Caja 1..." />
              </div>
              <div class="field">
                <label>Hora inicio</label>
                <input id="closeStart" type="time" />
              </div>
              <div class="field">
                <label>Hora fin</label>
                <input id="closeEnd" type="time" />
              </div>
              <div class="field full">
                <div class="rowflex">
                  <button class="btn primary" id="btnBuildClose">Generar cierre</button>
                  <button class="btn" id="btnSaveClose">Guardar cierre</button>
                </div>
                <div class="muted">Puedes generar <b>varios cierres en un mismo d√≠a</b> usando diferentes rangos de hora.</div>
              </div>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üí∞ Cuadre (dinero contado)</h3>
              <div class="muted">Ingresa lo que contaste en caja para comparar contra el sistema (seg√∫n el rango).</div>
              <div class="form" style="margin-top:10px">
                <div class="field">
                  <label>Efectivo contado</label>
                  <input id="countCash" type="number" min="0" step="0.01" value="0" />
                </div>
                <div class="field">
                  <label>Tarjeta contado</label>
                  <input id="countCard" type="number" min="0" step="0.01" value="0" />
                </div>
                <div class="field">
                  <label>Transferencia contado</label>
                  <input id="countTrans" type="number" min="0" step="0.01" value="0" />
                </div>
                <div class="field">
                  <label>&nbsp;</label>
                  <button class="btn warn" id="btnRecalcClose">Recalcular cuadre</button>
                </div>
              </div>
              <div class="muted" style="margin-top:8px">Diferencia = Contado - Sistema. Si es positivo, <b>sobra</b>. Si es negativo, <b>falta</b>.</div>
            </div>

            <div class="muted" style="margin-top:10px">
              Incluye ventas del rango, formas de pago, descuentos, env√≠os pagados y productos vendidos.
            </div>

            <div style="margin-top:12px; overflow:auto">
              <table class="table">
                <thead>
                  <tr>
                    <th>Hora</th>
                    <th>Cliente</th>
                    <th>Tipo</th>
                    <th>Pago</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody id="closeHistBody"></tbody>
              </table>
            </div>

            <div class="card" style="margin-top:12px">
              <h3>üìö Cierres guardados (por fecha)</h3>
              <div class="rowflex">
                <button class="btn" id="btnCloseListRefresh">Refrescar lista</button>
              </div>
              <div style="margin-top:12px; overflow:auto">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Rango</th>
                      <th>Nombre</th>
                      <th>Total</th>
                      <th style="width:220px">Acci√≥n</th>
                    </tr>
                  </thead>
                  <tbody id="closeListBody"></tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>üìÑ Ticket de cierre</h3>
            <div class="rowflex">
              <button class="btn" id="btnCloseCopy">Copiar texto</button>
              <button class="btn" id="btnClosePDF">PDF</button>
              <button class="btn" id="btnClosePNG">PNG</button>
              <button class="btn primary" id="btnCloseWA">WhatsApp</button>
            </div>

            <div class="receiptWrap" style="margin-top:12px">
              <div class="receipt" id="closeBox">
                <img class="cornerLogo" src="LOGO1.png" alt="Logo" />
                <div class="logo">
                  <div>
                    <b id="cShop">Tienda de Ropa</b>
                    <small id="cMeta">Cierre ‚Ä¢ Turno</small>
                  </div>
                  <div style="text-align:right">
                    <b id="cDate">‚Äî</b>
                    <small id="cTime">‚Äî</small>
                  </div>
                </div>

                <div class="line"><span>Rango</span><span id="cRange">‚Äî</span></div>
                <div class="line"><span>Ventas</span><span id="cSales">0</span></div>
                <div class="line"><span>Mostrador</span><span id="cMost">0</span></div>
                <div class="line"><span>Env√≠os pagados</span><span id="cEnv">0</span></div>
                <div class="hr"></div>

                <div class="line"><span>EFECTIVO</span><span id="cCash">Q0.00</span></div>
                <div class="line"><span>TARJETA</span><span id="cCard">Q0.00</span></div>
                <div class="line"><span>TRANSFER.</span><span id="cTrans">Q0.00</span></div>
                <div class="hr"></div>

                <div class="line"><span>Subtotal</span><span id="cSub">Q0.00</span></div>
                <div class="line"><span>Descuentos</span><span id="cDisc">Q0.00</span></div>
                <div class="big"><span>Total</span><span id="cTotal">Q0.00</span></div>

                <div class="hr"></div>
                <div class="muted">Cuadre</div>
                <div class="line"><span>Contado</span><span id="cCounted">Q0.00</span></div>
                <div class="line"><span>Diferencia</span><span id="cDiff">Q0.00</span></div>

                <div class="hr"></div>
                <div class="muted">Productos vendidos</div>
                <div id="cProducts" style="margin-top:8px"></div>

                <div class="foot">Cierre generado ‚úÖ</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- SETTINGS VIEW -->
      <section id="view-settings" class="hide">
        <div class="card">
          <h3>‚öôÔ∏è Ajustes</h3>

          <div class="form">
            <div class="field full">
              <label>Nombre de la tienda (sale en el recibo)</label>
              <input id="sShopName" placeholder="Ej: Boutique Karina"/>
            </div>

            <div class="field">
              <label>Auto PDF al cobrar</label>
              <select id="sAutoPDF">
                <option value="1">S√ç</option>
                <option value="0">NO</option>
              </select>
            </div>

            <div class="field">
              <label>Auto PNG al cobrar</label>
              <select id="sAutoPNG">
                <option value="1">S√ç</option>
                <option value="0">NO</option>
              </select>
            </div>

            <div class="field full">
              <h3 style="margin:10px 0 6px 0">üìè Tama√±o de impresi√≥n/PNG/PDF para ENV√çO</h3>
              <div class="muted">Solo afecta cuando la venta es <b>ENV√çO</b>. MOSTRADOR mantiene el tama√±o actual.</div>
            </div>

            <div class="field">
              <label>Ancho del recibo ENV√çO (px)</label>
              <input id="sShipReceiptW" type="number" min="240" step="1" placeholder="Ej: 360" />
            </div>

            <div class="field">
              <label>Escala PNG ENV√çO (recomendado 2 o 3)</label>
              <input id="sShipPngScale" type="number" min="1" step="1" placeholder="Ej: 2" />
            </div>

            <div class="field">
              <label>Escala PDF ENV√çO (recomendado 1 o 2)</label>
              <input id="sShipPdfScale" type="number" min="1" step="0.25" placeholder="Ej: 1" />
            </div>

            <div class="field">
              <label>C√≥digo para editar ajustes</label>
              <input id="sSettingsCode" type="password" placeholder="Ingresa c√≥digo para guardar" />
            </div>

            <div class="field full">
              <button class="btn primary" id="btnSaveSettings">Guardar</button>
            </div>
          </div>

          <div class="muted" style="margin-top:10px">
            Nota: todo se guarda en tu navegador. Si cambias de PC/navegador, exporta e importa el JSON.
          </div>
        </div>
      </section>

      <input type="file" id="restoreFile" accept="application/json" class="hide"/>
      <canvas id="cnv" class="hide"></canvas>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ============================================================
   POS Boutique Offline (IndexedDB) ‚Äî v2
   + Tama√±o PNG/PDF configurable SOLO para ENV√çO (en Ajustes) con c√≥digo
   + Env√≠os pendientes (no cuentan como venta hasta PAGADO)
   + Cierres por rango (varios cierres al d√≠a) + cuadre por formas de pago
   - Mantiene funciones originales
============================================================ */

const DB_NAME = "pos_boutique_offline_v1";
const DB_VER = 3; // <-- subido por stores nuevos
let db;

const SETTINGS_EDIT_CODE = "363534"; // c√≥digo para editar ajustes sensibles (tama√±o env√≠o)

const state = {
  view: "pos",
  cart: [],
  selectedClient: null,
  lastReceipt: null,
  lastClose: null,
  selectedShipment: null,
  discount: { type:"NONE", value:0 },
  settings: {
    shopName: "Tienda de Ropa",
    autoPDF:true,
    autoPNG:true,
    shipReceiptW: 360,       // px
    shipPngScale: 2,         // html2canvas scale
    shipPdfScale: 1          // escala visual en HTML de impresi√≥n
  }
};

const $ = (id)=>document.getElementById(id);
const money = (n)=> "Q" + (Number(n||0)).toFixed(2);

// ---------- IndexedDB ----------
function openDB(){
  return new Promise((resolve,reject)=>{
    const req = indexedDB.open(DB_NAME, DB_VER);
    req.onupgradeneeded = (e)=>{
      const db = e.target.result;

      if(!db.objectStoreNames.contains("clients")){
        const s = db.createObjectStore("clients", { keyPath:"phone" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("products")){
        const s = db.createObjectStore("products", { keyPath:"code" });
        s.createIndex("name", "nameKey", { unique:false });
      }
      if(!db.objectStoreNames.contains("sales")){
        const s = db.createObjectStore("sales", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
      }
      if(!db.objectStoreNames.contains("meta")){
        db.createObjectStore("meta", { keyPath:"key" });
      }

      // NUEVO: env√≠os pendientes
      if(!db.objectStoreNames.contains("shipments")){
        const s = db.createObjectStore("shipments", { keyPath:"id" });
        s.createIndex("ts", "ts", { unique:false });
        s.createIndex("status", "status", { unique:false });
        s.createIndex("dateKey", "dateKey", { unique:false });
      }

      // NUEVO: cierres guardados
      if(!db.objectStoreNames.contains("closes")){
        const s = db.createObjectStore("closes", { keyPath:"id" });
        s.createIndex("dateKey", "dateKey", { unique:false });
        s.createIndex("ts", "ts", { unique:false });
      }
    };
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = ()=>reject(req.error);
  });
}

function tx(store, mode="readonly"){
  return db.transaction(store, mode).objectStore(store);
}
function idbGet(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store).get(key);
    r.onsuccess=()=>res(r.result||null);
    r.onerror=()=>rej(r.error);
  });
}
function idbPut(store, val){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").put(val);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbDel(store, key){
  return new Promise((res,rej)=>{
    const r = tx(store,"readwrite").delete(key);
    r.onsuccess=()=>res(true);
    r.onerror=()=>rej(r.error);
  });
}
function idbAll(store){
  return new Promise((res,rej)=>{
    const r = tx(store).getAll();
    r.onsuccess=()=>res(r.result||[]);
    r.onerror=()=>rej(r.error);
  });
}
function idbClearAll(){
  return Promise.all([
    new Promise((res,rej)=>{ const r=db.transaction("clients","readwrite").objectStore("clients").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("products","readwrite").objectStore("products").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("sales","readwrite").objectStore("sales").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("meta","readwrite").objectStore("meta").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("shipments","readwrite").objectStore("shipments").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
    new Promise((res,rej)=>{ const r=db.transaction("closes","readwrite").objectStore("closes").clear(); r.onsuccess=()=>res(true); r.onerror=()=>rej(r.error); }),
  ]);
}

// ---------- Helpers ----------
function todayKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function weekKey(ts=Date.now()){
  const d = new Date(ts);
  const tmp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const dayNum = tmp.getUTCDay() || 7;
  tmp.setUTCDate(tmp.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(tmp.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((tmp - yearStart) / 86400000) + 1)/7);
  return `${tmp.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
}
function monthKey(ts=Date.now()){
  const d = new Date(ts);
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  return `${y}-${m}`;
}
function escapeHtml(s){
  return String(s||"")
    .replaceAll("&","&amp;").replaceAll("<","&lt;")
    .replaceAll(">","&gt;").replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function normKey(s){
  return String(s||"").trim().toLowerCase().replace(/\s+/g," ");
}
function pad(n,len=6){ return String(n).padStart(len,"0"); }

function parseDateTime(dateKey, timeStr){
  const [y,m,d] = dateKey.split("-").map(Number);
  const [hh,mm] = (timeStr||"00:00").split(":").map(Number);
  return new Date(y, m-1, d, hh||0, mm||0, 0, 0).getTime();
}
function fmtRange(dateKey, startTime, endTime){
  return `${dateKey} ${startTime||"00:00"} - ${endTime||"23:59"}`;
}

// ---------- UI Nav ----------
const views = {
  pos: {title:"Cobro (POS)", sub:""},
  shipments: {title:"Env√≠os pendientes", sub:"Env√≠os en espera: solo PAGADOS se vuelven ventas."},
  clients: {title:"Clientes", sub:"Busca por tel√©fono, edita y usa para env√≠os."},
  reports: {title:"Reportes", sub:"Diario / Semanal / Mensual con historial de ventas."},
  products: {title:"Productos", sub:"Agrega productos con c√≥digo, nombre, precio y stock."},
  inventory: {title:"Inventarios", sub:"Tabla de productos + stock actual."},
  close: {title:"Cierre", sub:"Varios cierres por d√≠a: por rango + cuadre de pagos."},
  settings: {title:"Ajustes", sub:"Nombre de tienda, tama√±os ENV√çO y respaldos (exportar/importar)."}
};

function setView(v){
  state.view = v;
  $("viewTitle").textContent = views[v].title;
  $("viewSub").textContent = views[v].sub;

  for(const k of Object.keys(views)){
    $("view-"+k).classList.toggle("hide", k!==v);
  }
  [...document.querySelectorAll(".nav button")].forEach(b=>{
    b.classList.toggle("active", b.dataset.view===v);
  });

  if(v==="clients") renderClients();
  if(v==="products") { renderProducts(); refreshProductPicker(); }
  if(v==="reports") renderReport("daily");
  if(v==="inventory") renderInventory();
  if(v==="close") buildClose();
  if(v==="shipments") renderShipments();
}

// ---------- Descuentos ----------
function cartSubtotal(){
  return state.cart.reduce((a,x)=>a + x.qty*x.price, 0);
}
function cartDiscountAmount(subtotal = cartSubtotal()){
  const t = state.discount?.type || "NONE";
  const v = Number(state.discount?.value || 0);
  if(!v || v<=0 || t==="NONE") return 0;
  if(t==="Q") return Math.min(v, subtotal);
  if(t==="PCT") return Math.min(subtotal, subtotal * (v/100));
  return 0;
}
function cartTotal(){
  const sub = cartSubtotal();
  const disc = cartDiscountAmount(sub);
  return Math.max(sub - disc, 0);
}
function syncDiscUI(){
  $("discType").value = state.discount?.type || "NONE";
  $("discValue").value = String(state.discount?.value ?? 0);
}

// ---------- Tama√±o recibo ENVIO (solo) ----------
function applyReceiptSizingForCurrentSaleType(){
  const isShip = $("saleType").value === "ENVIO";
  const w = Number(state.settings.shipReceiptW || 360);
  document.documentElement.style.setProperty("--shipReceiptW", `${Math.max(240, w)}px`);

  const receipt = $("receiptBox");
  if(receipt){
    receipt.classList.toggle("ship", isShip);
  }
}

// ---------- Cart ----------
function renderCart(){
  const body = $("cartBody");
  body.innerHTML = "";

  let subtotal = 0;
  for(const item of state.cart){
    const line = item.qty * item.price;
    subtotal += line;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${item.qty}</td>
      <td>${escapeHtml(item.name)}<br><small>${escapeHtml(item.code)}</small></td>
      <td>${money(item.price)}</td>
      <td>${money(line)}</td>
      <td>
        <button class="btn small" data-act="minus" data-code="${escapeHtml(item.code)}">-</button>
        <button class="btn small" data-act="plus" data-code="${escapeHtml(item.code)}">+</button>
        <button class="btn danger small" data-act="del" data-code="${escapeHtml(item.code)}">X</button>
      </td>
    `;
    body.appendChild(tr);
  }

  const disc = cartDiscountAmount(subtotal);
  const total = Math.max(subtotal - disc, 0);

  $("subTotal").textContent = money(subtotal);
  $("discTotal").textContent = money(disc);
  $("grandTotal").textContent = money(total);
  updateReceiptPreview();
}

function cartAdd(product, qty=1){
  qty = Number(qty||1);
  if(qty<1) qty=1;
  const found = state.cart.find(x=>x.code===product.code);
  if(found) found.qty += qty;
  else state.cart.push({code:product.code, name:product.name, price:Number(product.price), qty});
  renderCart();
}

function cartInc(code, delta){
  const it = state.cart.find(x=>x.code===code);
  if(!it) return;
  it.qty += delta;
  if(it.qty<=0) state.cart = state.cart.filter(x=>x.code!==code);
  renderCart();
}

function cartClear(){
  state.cart = [];
  renderCart();
}

// ---------- Clients ----------
async function findClientByPhone(phone){
  phone = String(phone||"").trim();
  if(!phone) return null;
  return await idbGet("clients", phone);
}

async function saveClientFromForm(){
  const phone = $("cPhone").value.trim();
  const names = $("cNames").value.trim();
  const last  = $("cLast").value.trim();
  const addr  = $("cAddr").value.trim();

  if(!phone) return alert("Ingrese tel√©fono.");
  if(!names || !last || !addr) return alert("Complete Nombres, Apellidos y Direcci√≥n.");

  const client = {
    phone,
    names, last, addr,
    nameKey: normKey(names+" "+last),
    updatedAt: Date.now()
  };
  await idbPut("clients", client);
  state.selectedClient = client;
  alert("Cliente guardado.");
  await refreshKPIs();
  if(state.view==="clients") renderClients();
  updateReceiptPreview();
}

async function renderClients(){
  const q = normKey($("clientSearch").value);
  const all = await idbAll("clients");
  const list = q ? all.filter(c => normKey(c.phone).includes(q) || (c.nameKey||"").includes(q) || normKey(c.addr).includes(q)) : all;

  const tb = $("clientsBody");
  tb.innerHTML = "";
  for(const c of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(c.phone)}</td>
      <td>${escapeHtml(c.names)} ${escapeHtml(c.last)}</td>
      <td><small>${escapeHtml(c.addr)}</small></td>
      <td>
        <button class="btn small" data-useclient="${escapeHtml(c.phone)}">Usar</button>
        <button class="btn danger small" data-delclient="${escapeHtml(c.phone)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Products ----------
async function saveProductFromForm(){
  const code = $("pCode").value.trim();
  const name = $("pName").value.trim();
  const price = Number($("pPrice").value);
  const stock = Number($("pStock").value);

  if(!code) return alert("Ingrese C√≥digo (SKU/barras).");
  if(!name) return alert("Ingrese Nombre.");
  if(isNaN(price) || price<0) return alert("Precio inv√°lido.");
  if(isNaN(stock) || stock<0) return alert("Stock inv√°lido.");

  const exists = await idbGet("products", code);
  if(exists){
    if(!requireCode("editar producto")) return;
  }

  const product = {
    code, name,
    price, stock,
    nameKey: normKey(name),
    updatedAt: Date.now()
  };
  await idbPut("products", product);
  alert("Producto guardado.");
  $("pCode").value=""; $("pName").value=""; $("pPrice").value=""; $("pStock").value="";
  await refreshKPIs();
  renderProducts();
  refreshProductPicker();
}

async function getProductByCode(code){
  return await idbGet("products", code);
}

async function renderProducts(){
  const q = normKey($("prodSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q)) : all;

  const tb = $("productsBody");
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td>${Number(p.stock||0)}</td>
      <td>
        <button class="btn small" data-fillprod="${escapeHtml(p.code)}">Editar</button>
        <button class="btn danger small" data-delprod="${escapeHtml(p.code)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

async function refreshProductPicker(){
  const q = normKey($("productSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p=> (p.nameKey||"").includes(q) || normKey(p.code).includes(q)) : all;

  const sel = $("productPicker");
  sel.innerHTML = "";
  if(list.length===0){
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = "No hay productos (agrega en Productos)";
    sel.appendChild(opt);
    return;
  }
  for(const p of list.slice(0,300)){
    const opt = document.createElement("option");
    opt.value = p.code;
    opt.textContent = `${p.name} ‚Äî ${p.code} ‚Äî ${money(p.price)} ‚Äî Stock:${p.stock}`;
    sel.appendChild(opt);
  }
}

// ---------- Inventory ----------
async function renderInventory(){
  const q = normKey($("invSearch").value);
  const all = await idbAll("products");
  const list = q ? all.filter(p => normKey(p.code).includes(q) || (p.nameKey||"").includes(q)) : all;

  const tb = $("invBody");
  tb.innerHTML = "";
  for(const p of list.sort((a,b)=> (a.nameKey||"").localeCompare(b.nameKey||""))){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(p.code)}</td>
      <td>${escapeHtml(p.name)}</td>
      <td>${money(p.price)}</td>
      <td>${Number(p.stock||0)}</td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Sales / Checkout ----------
async function nextReceiptNo(){
  const meta = await idbGet("meta","receiptNo");
  const n = meta?.value ? Number(meta.value) : 1;
  await idbPut("meta",{key:"receiptNo", value:n+1});
  return n;
}
async function nextShipmentNo(){
  const meta = await idbGet("meta","shipNo");
  const n = meta?.value ? Number(meta.value) : 1;
  await idbPut("meta",{key:"shipNo", value:n+1});
  return n;
}

function requireClientIfShipping(){
  const type = $("saleType").value;
  if(type==="ENVIO"){
    const c = state.selectedClient;
    if(!c || !c.phone || !c.names || !c.last || !c.addr){
      return {ok:false, msg:"En ENV√çO es obligatorio seleccionar/crear un cliente con tel√©fono, nombre y direcci√≥n."};
    }
  }
  return {ok:true};
}

async function validateAndDeductStock(items){
  // Validate
  for(const it of items){
    const p = await getProductByCode(it.code);
    if(!p) throw new Error("Producto no existe: " + it.code);
    if(Number(p.stock||0) < it.qty) throw new Error(`Stock insuficiente para "${p.name}". Stock:${p.stock} Cant:${it.qty}`);
  }
  // Deduct
  for(const it of items){
    const p = await getProductByCode(it.code);
    p.stock = Number(p.stock||0) - it.qty;
    p.updatedAt = Date.now();
    await idbPut("products", p);
  }
}

async function checkout(){
  if(state.cart.length===0) return alert("No hay productos en la venta.");
  const clientRule = requireClientIfShipping();
  if(!clientRule.ok) return alert(clientRule.msg);

  const saleType = $("saleType").value;
  const payMethod = $("payMethod").value;

  const subtotal = cartSubtotal();
  const discountAmount = cartDiscountAmount(subtotal);
  const total = Math.max(subtotal - discountAmount, 0);

  const ts = Date.now();
  const client = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);

  // ENVIO: crear env√≠o pendiente o pagado (solo pagado crea venta)
  if(saleType==="ENVIO"){
    const shipNo = await nextShipmentNo();
    const shipId = "SH-" + ts + "-" + Math.random().toString(16).slice(2,8);
    const shipReceiptNo = "ENV-" + pad(shipNo, 6);

    const paidNow = confirm("¬øEste ENV√çO ya fue PAGADO?\n\nAceptar = PAGADO (se registra venta y descuenta stock)\nCancelar = PENDIENTE (no se registra venta todav√≠a)");
    const status = paidNow ? "PAGADO" : "PENDIENTE";

    const shipment = {
      id: shipId,
      ts,
      dateKey: todayKey(ts),
      status,
      shipNo: shipReceiptNo,
      payMethod,
      client: client ? { phone:client.phone, names:client.names, last:client.last, addr:client.addr } : null,
      items: state.cart.map(x=>({...x})),
      subtotal: Number(subtotal.toFixed(2)),
      discountType: state.discount.type,
      discountValue: Number(state.discount.value||0),
      discountAmount: Number(discountAmount.toFixed(2)),
      total: Number(total.toFixed(2)),
      shop: state.settings.shopName || "Tienda de Ropa",
      paidAt: paidNow ? Date.now() : null,
      saleId: null
    };

    if(paidNow){
      // se vuelve venta real
      try{
        await validateAndDeductStock(shipment.items);
      }catch(err){
        return alert(String(err.message||err));
      }
      const receiptNo = await nextReceiptNo();
      const sale = {
        id: "S-" + Date.now() + "-" + Math.random().toString(16).slice(2,8),
        ts: shipment.paidAt,
        dateKey: todayKey(shipment.paidAt),
        weekKey: weekKey(shipment.paidAt),
        monthKey: monthKey(shipment.paidAt),
        saleType: "ENVIO",
        payMethod,
        client: shipment.client,
        items: shipment.items.map(x=>({...x})),
        subtotal: shipment.subtotal,
        discountType: shipment.discountType,
        discountValue: shipment.discountValue,
        discountAmount: shipment.discountAmount,
        total: shipment.total,
        receiptNo: pad(receiptNo, 6),
        shop: shipment.shop,
        linkShipmentId: shipment.id
      };
      await idbPut("sales", sale);
      shipment.saleId = sale.id;
      state.lastReceipt = sale;
    }else{
      state.lastReceipt = null;
    }

    await idbPut("shipments", shipment);

    // reset carrito + descuento
    state.discount = {type:"NONE", value:0};
    syncDiscUI();
    cartClear();
    await refreshKPIs();
    refreshProductPicker();
    if(state.view==="inventory") renderInventory();
    updateReceiptPreview();

    await renderShipments();

    if(paidNow){
      // Auto descargas (aplican al recibo de venta)
      if(state.settings.autoPDF) setTimeout(()=>{ try{ generatePDF(); }catch(e){} }, 200);
      if(state.settings.autoPNG) setTimeout(()=>{ try{ downloadReceiptPNG(); }catch(e){} }, 700);
      alert("ENV√çO registrado como PAGADO ‚úÖ. Se registr√≥ venta y se descont√≥ stock.");
    }else{
      alert("ENV√çO guardado como PENDIENTE ‚è≥. No cuenta como venta hasta que lo marques como PAGADO en 'Env√≠os pendientes'.");
    }
    return;
  }

  // MOSTRADOR: flujo original
  const id = "S-" + ts + "-" + Math.random().toString(16).slice(2,8);
  const receiptNo = await nextReceiptNo();

  try{
    await validateAndDeductStock(state.cart);
  }catch(err){
    return alert(String(err.message||err));
  }

  const sale = {
    id, ts,
    dateKey: todayKey(ts),
    weekKey: weekKey(ts),
    monthKey: monthKey(ts),
    saleType, payMethod,
    client: client ? { phone:client.phone, names:client.names, last:client.last, addr:client.addr } : null,
    items: state.cart.map(x=>({...x})),
    subtotal: Number(subtotal.toFixed(2)),
    discountType: state.discount.type,
    discountValue: Number(state.discount.value||0),
    discountAmount: Number(discountAmount.toFixed(2)),
    total: Number(total.toFixed(2)),
    receiptNo: pad(receiptNo, 6),
    shop: state.settings.shopName || "Tienda de Ropa"
  };

  await idbPut("sales", sale);
  state.lastReceipt = sale;

  state.discount = {type:"NONE", value:0};
  syncDiscUI();

  cartClear();
  await refreshKPIs();
  refreshProductPicker();
  if(state.view==="inventory") renderInventory();
  updateReceiptPreview();

  if(state.settings.autoPDF) setTimeout(()=>{ try{ generatePDF(); }catch(e){} }, 200);
  if(state.settings.autoPNG) setTimeout(()=>{ try{ downloadReceiptPNG(); }catch(e){} }, 700);

  alert("Venta registrada. Recibo listo para WhatsApp/PDF/PNG.");
}

// ---------- Reports ----------
async function renderReport(mode){
  const all = await idbAll("sales");
  const now = Date.now();
  let list = [];

  if(mode==="daily"){
    const k = todayKey(now);
    list = all.filter(s=>s.dateKey===k);
  }else if(mode==="weekly"){
    const k = weekKey(now);
    list = all.filter(s=>s.weekKey===k);
  }else{
    const k = monthKey(now);
    list = all.filter(s=>s.monthKey===k);
  }

  const total = list.reduce((a,s)=>a+Number(s.total||0),0);
  $("repCount").textContent = list.length;
  $("repTotal").textContent = money(total);

  const tb = $("salesBody");
  tb.innerHTML = "";
  for(const s of list.sort((a,b)=>b.ts-a.ts)){
    const d = new Date(s.ts);
    const when = d.toLocaleString();
    const c = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(c)}<br><small>${escapeHtml(s.saleType||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total)}</td>
      <td>
        <button class="btn small" data-viewsale="${escapeHtml(s.id)}">Ver</button>
        <button class="btn danger small" data-delsale="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

// ---------- Receipt (text + preview + PDF + PNG) ----------
function makeLiveReceipt(){
  const saleType = $("saleType").value;
  const payMethod = $("payMethod").value;
  const c = (saleType==="ENVIO") ? state.selectedClient : (state.selectedClient || null);
  return {
    ts: Date.now(),
    receiptNo: state.lastReceipt?.receiptNo || String($("rNo").textContent||"").replace("#","") || "------",
    shop: state.settings.shopName,
    saleType, payMethod,
    client: c ? {phone:c.phone, names:c.names, last:c.last, addr:c.addr} : null,
    items: state.cart.map(x=>({...x})),
    subtotal: cartSubtotal(),
    discountAmount: cartDiscountAmount(cartSubtotal()),
    total: cartTotal()
  };
}

function saleToReceiptText(s){
  if(!s) return "No hay recibo todav√≠a.";
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone = s.client?.phone || "‚Äî";
  const addr  = s.client?.addr || "‚Äî";
  const lines = [];
  lines.push(`üßæ *${s.shop}*`);
  lines.push(`Recibo #${s.receiptNo}`);
  lines.push(`Fecha: ${d}`);
  lines.push(`Tipo: ${s.saleType} | Pago: ${s.payMethod}`);
  lines.push(`Cliente: ${client}`);
  lines.push(`Tel: ${phone}`);
  lines.push(`Dir: ${addr}`);
  lines.push(`--------------------------------`);
  for(const it of (s.items||[])){
    lines.push(`${it.qty} x ${it.name} = ${money(it.qty*it.price)}`);
  }
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(s.subtotal ?? s.total)}`);
  lines.push(`DESCUENTO: ${money(s.discountAmount ?? 0)}`);
  lines.push(`TOTAL: *${money(s.total)}*`);
  lines.push(`Gracias por tu compra üíó`);
  return lines.join("\n");
}

function updateReceiptPreview(){
  applyReceiptSizingForCurrentSaleType();

  const s = state.lastReceipt || makeLiveReceipt();
  $("rShop").textContent = s.shop || state.settings.shopName || "Tienda de Ropa";
  $("rMeta").textContent = `Recibo ‚Ä¢ ${s.saleType || "MOSTRADOR"} ‚Ä¢ ${s.payMethod || "EFECTIVO"}`;
  $("rNo").textContent = "#" + (s.receiptNo || "------");
  $("rDate").textContent = new Date(s.ts || Date.now()).toLocaleString();

  const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  $("rClient").textContent = client;
  $("rPhone").textContent = s.client?.phone || "‚Äî";
  $("rAddr").textContent  = s.client?.addr || "‚Äî";
  $("rPay").textContent   = s.payMethod || $("payMethod").value;

  const itemsDiv = $("rItems");
  itemsDiv.innerHTML = "";
  for(const it of (s.items||[])){
    const line = document.createElement("div");
    line.className="line";
    line.innerHTML = `<span>${it.qty} x ${escapeHtml(it.name)}</span><span>${money(it.qty*it.price)}</span>`;
    itemsDiv.appendChild(line);
  }

  $("rSub").textContent = money(s.subtotal ?? cartSubtotal());
  $("rDisc").textContent = money(s.discountAmount ?? cartDiscountAmount(s.subtotal ?? cartSubtotal()));
  $("rTotal").textContent = money(s.total ?? cartTotal());
}

async function copyReceipt(){
  const s = state.lastReceipt || makeLiveReceipt();
  const text = saleToReceiptText(s);
  try{
    await navigator.clipboard.writeText(text);
    alert("Recibo copiado. P√©galo en WhatsApp.");
  }catch{
    alert("No se pudo copiar autom√°ticamente. Intenta copiar manualmente desde WhatsApp.");
  }
}

function openWhatsApp(){
  const s = state.lastReceipt || makeLiveReceipt();
  const text = saleToReceiptText(s);
  const url = "https://wa.me/?text=" + encodeURIComponent(text);
  window.open(url, "_blank");
}

// --- Seguridad (c√≥digo para borrar/editar) ---
function requireCode(action){
  const code = prompt(`Ingrese el c√≥digo para ${action}:`);
  if(code===null) return false;
  if(String(code).trim() !== "363534"){
    alert("C√≥digo incorrecto.");
    return false;
  }
  return true;
}

// --- Seguridad (c√≥digo para backup/restore) ---
function requireBackupCode(action){
  const code = prompt(`Ingrese el c√≥digo para ${action}:`);
  if(code===null) return false;
  if(String(code).trim() !== "22782522"){
    alert("C√≥digo incorrecto.");
    return false;
  }
  return true;
}

// --- Seguridad (c√≥digo para ajustar tama√±os env√≠o) ---
function requireSettingsEditCode(){
  const code = String($("sSettingsCode")?.value || "").trim();
  if(!code) { alert("Ingresa el c√≥digo para guardar ajustes."); return false; }
  if(code !== SETTINGS_EDIT_CODE){
    alert("C√≥digo incorrecto.");
    return false;
  }
  return true;
}

// --- Captura PNG robusta (evita blanco/opaco) ---
async function capturePNG(node, filename, scale=2){
  if(!node) throw new Error("Nodo no encontrado.");
  if(!window.html2canvas) throw new Error("html2canvas no disponible.");

  document.body.classList.add("capture-mode");
  await new Promise(r=>requestAnimationFrame(r));

  try{
    const canvas = await html2canvas(node, {
      backgroundColor:"#ffffff",
      scale: Math.max(1, Number(scale||2)),
      useCORS: true,
      allowTaint: true,
      logging: false,
      removeContainer: true
    });

    return await new Promise((resolve,reject)=>{
      canvas.toBlob((blob)=>{
        if(!blob) return reject(new Error("PNG bloqueado o en blanco."));
        const a = document.createElement("a");
        const url = URL.createObjectURL(blob);
        a.href = url;
        a.download = filename;
        a.click();
        setTimeout(()=>URL.revokeObjectURL(url), 1000);
        resolve(true);
      }, "image/png");
    });
  }finally{
    document.body.classList.remove("capture-mode");
  }
}

// PNG (preferir html2canvas; fallback SVG)
async function downloadReceiptPNG(){
  const node = $("receiptBox");
  if(!node) return;

  const isShip = ($("saleType").value === "ENVIO") || (state.lastReceipt?.saleType === "ENVIO");
  const scale = isShip ? Number(state.settings.shipPngScale||2) : 2;

  if(window.html2canvas){
    try{
      await capturePNG(node, `recibo_${(state.lastReceipt?.receiptNo||"----")}.png`, scale);
      return;
    }catch(e){
      // fallback abajo
    }
  }

  const w = node.offsetWidth;
  const h = node.offsetHeight;

  const clone = node.cloneNode(true);
  clone.style.boxShadow="none";

  const wrapper = document.createElement("div");
  wrapper.style.width = w+"px";
  wrapper.style.height = h+"px";
  wrapper.style.background = "#fff";
  wrapper.appendChild(clone);

  const html = new XMLSerializer().serializeToString(wrapper);
  const data = `
    <svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}">
      <foreignObject width="100%" height="100%">
        <div xmlns="http://www.w3.org/1999/xhtml">
          ${html}
        </div>
      </foreignObject>
    </svg>
  `;
  const svgBlob = new Blob([data], {type:"image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(svgBlob);

  const img = new Image();
  img.onload = ()=>{
    const cnv = $("cnv");
    cnv.width = w*2;
    cnv.height = h*2;
    const ctx = cnv.getContext("2d");
    ctx.scale(2,2);
    ctx.fillStyle="#fff"; ctx.fillRect(0,0,w,h);
    ctx.drawImage(img, 0,0);
    URL.revokeObjectURL(url);

    cnv.toBlob((blob)=>{
      if(!blob) return alert("Tu navegador bloque√≥ el PNG. Usa PDF o Copiar texto.");
      const a = document.createElement("a");
      const u = URL.createObjectURL(blob);
      a.href = u;
      a.download = `recibo_${(state.lastReceipt?.receiptNo||"----")}.png`;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(u), 1000);
    }, "image/png");
  };
  img.onerror = ()=>{
    URL.revokeObjectURL(url);
    alert("Tu navegador bloque√≥ el PNG. Usa PDF o Copiar texto.");
  };
  img.src = url;
}

function receiptToPrintableHTML(s){
  const d = new Date(s.ts || Date.now()).toLocaleString();
  const clientName = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
  const phone = s.client?.phone || "‚Äî";
  const addr  = s.client?.addr  || "‚Äî";

  const isShip = (s.saleType === "ENVIO");
  const scale = isShip ? Number(state.settings.shipPdfScale||1) : 1;
  const shipW = Math.max(240, Number(state.settings.shipReceiptW||360));

  const rows = (s.items||[]).map(it=>{
    const line = (it.qty||0) * (it.price||0);
    return `
      <tr>
        <td style="text-align:center">${it.qty}</td>
        <td>${escapeHtml(it.name)}</td>
        <td style="text-align:right">${money(it.price)}</td>
        <td style="text-align:right">${money(line)}</td>
      </tr>
    `;
  }).join("");

  const sub = Number(s.subtotal ?? 0);
  const disc = Number(s.discountAmount ?? 0);
  const total = Number(s.total ?? 0);

  return `
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Recibo ${escapeHtml(s.receiptNo || "")}</title>
    <style>
      body{ font-family: Arial, sans-serif; margin: 20px; color:#111; background:#fff7fb; }
      .box{
        position:relative;
        max-width: ${isShip ? shipW : 820}px;
        margin: 0 auto;
        border:2px solid #fbcfe8;
        border-radius:16px;
        padding:16px;
        background:#fff;
        transform: scale(${scale});
        transform-origin: top center;
      }
      .cornerLogo{ position:absolute; top:12px; right:12px; width:60px; height:60px; object-fit:contain; border-radius:14px; border:1px solid #eee; padding:4px; background:#fff; }
      .bar{ height:8px; border-radius:999px; background: linear-gradient(90deg, #ff4fb7, #a855f7); margin-bottom:12px; }
      h1{ margin:0; font-size:18px; color:#7b2fb4; padding-right:70px; }
      .meta{ margin-top:4px; color:#444; font-size:12px; font-weight:700; }
      .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:14px; }
      .card{ border:1px solid #eee; border-radius:12px; padding:12px; }
      .label{ color:#666; font-size:12px; font-weight:700; }
      .val{ font-size:13px; font-weight:800; margin-top:3px; }
      table{ width:100%; border-collapse:collapse; margin-top:14px; }
      th,td{ border-bottom:1px solid #eee; padding:8px; font-size:13px; }
      th{ background:#ffe4f1; text-align:left; }
      .totalRow{ display:flex; justify-content:space-between; margin-top:10px; font-weight:900; font-size:14px; }
      .foot{ margin-top:12px; color:#444; font-size:12px; font-weight:700; }
      @media print{
        body{ margin:0; }
        .box{ border:none; border-radius:0; transform:none; }
      }
    </style>
  </head>
  <body onload="setTimeout(function(){window.print();},250)">
    <div class="box">
      <img class="cornerLogo" src="LOGO1.png" alt="Logo" />
      <div class="bar"></div>
      <h1>${escapeHtml(s.shop || "Tienda de Ropa")} ‚Äî Recibo #${escapeHtml(s.receiptNo || "")}</h1>
      <div class="meta">${escapeHtml(d)} ‚Ä¢ Tipo: ${escapeHtml(s.saleType || "MOSTRADOR")} ‚Ä¢ Pago: ${escapeHtml(s.payMethod || "EFECTIVO")}</div>

      <div class="grid">
        <div class="card">
          <div class="label">Cliente</div>
          <div class="val">${escapeHtml(clientName)}</div>
          <div class="label" style="margin-top:10px">Tel√©fono</div>
          <div class="val">${escapeHtml(phone)}</div>
        </div>
        <div class="card">
          <div class="label">Direcci√≥n</div>
          <div class="val">${escapeHtml(addr)}</div>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th style="width:70px;text-align:center">Cant</th>
            <th>Producto</th>
            <th style="width:120px;text-align:right">Precio</th>
            <th style="width:120px;text-align:right">Total</th>
          </tr>
        </thead>
        <tbody>
          ${rows || `<tr><td colspan="4">Sin items</td></tr>`}
        </tbody>
      </table>

      <div class="totalRow"><div>SUBTOTAL</div><div>${money(sub)}</div></div>
      <div class="totalRow"><div>DESCUENTO</div><div>${money(disc)}</div></div>
      <div class="totalRow"><div>TOTAL</div><div>${money(total)}</div></div>

      <div class="foot">Gracias por tu compra üíó</div>
    </div>
  </body>
  </html>
  `;
}

function generatePDF(){
  const s = state.lastReceipt || makeLiveReceipt();

  if(s.saleType === "ENVIO"){
    const ok = s.client && s.client.phone && s.client.names && s.client.last && s.client.addr;
    if(!ok) return alert("Para ENV√çO debes tener cliente completo antes de generar el PDF.");
  }

  const html = receiptToPrintableHTML(s);
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para generar PDF.");
  w.document.open();
  w.document.write(html);
  w.document.close();
}

// ---------- Env√≠os pendientes ----------
async function renderShipments(){
  const q = normKey($("shipSearch").value);
  const filter = $("shipFilter").value;

  const all = await idbAll("shipments");
  let list = all;

  if(filter==="PENDIENTE") list = list.filter(s=>s.status==="PENDIENTE");
  if(filter==="PAGADO") list = list.filter(s=>s.status==="PAGADO");

  if(q){
    list = list.filter(s=>{
      const phone = normKey(s.client?.phone||"");
      const name  = normKey((s.client?.names||"") + " " + (s.client?.last||""));
      const idk   = normKey(s.shipNo||s.id||"");
      return phone.includes(q) || name.includes(q) || idk.includes(q);
    });
  }

  const tb = $("shipBody");
  tb.innerHTML = "";

  for(const s of list.sort((a,b)=>b.ts-a.ts)){
    const d = new Date(s.ts).toLocaleString();
    const c = s.client ? `${s.client.names} ${s.client.last}` : "‚Äî";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(d)}</small><br><small>#${escapeHtml(s.shipNo||"")}</small></td>
      <td>${escapeHtml(c)}<br><small>${escapeHtml(s.client?.phone||"")}</small></td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total||0)}</td>
      <td><b>${escapeHtml(s.status||"")}</b></td>
      <td>
        <button class="btn small" data-shipselect="${escapeHtml(s.id)}">Ver</button>
        ${s.status==="PENDIENTE" ? `<button class="btn ok small" data-shippay="${escapeHtml(s.id)}">Marcar PAGADO</button>` : ``}
        <button class="btn danger small" data-shipdel="${escapeHtml(s.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }

  // refrescar detalle si algo cambi√≥
  if(state.selectedShipment){
    const latest = await idbGet("shipments", state.selectedShipment.id);
    if(latest) { state.selectedShipment = latest; renderShipmentDetail(latest); }
  }
}

function shipmentToText(sh){
  if(!sh) return "No hay env√≠o seleccionado.";
  const d = new Date(sh.ts || Date.now()).toLocaleString();
  const client = sh.client ? `${sh.client.names} ${sh.client.last}` : "‚Äî";
  const lines = [];
  lines.push(`üöö *${sh.shop}*`);
  lines.push(`ENV√çO #${sh.shipNo}`);
  lines.push(`Fecha: ${d}`);
  lines.push(`Estatus: ${sh.status}`);
  lines.push(`Pago: ${sh.payMethod}`);
  lines.push(`Cliente: ${client}`);
  lines.push(`Tel: ${sh.client?.phone||"‚Äî"}`);
  lines.push(`Dir: ${sh.client?.addr||"‚Äî"}`);
  lines.push(`--------------------------------`);
  for(const it of (sh.items||[])){
    lines.push(`${it.qty} x ${it.name} = ${money(it.qty*it.price)}`);
  }
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(sh.subtotal ?? sh.total)}`);
  lines.push(`DESCUENTO: ${money(sh.discountAmount ?? 0)}`);
  lines.push(`TOTAL: *${money(sh.total)}*`);
  lines.push(sh.status==="PAGADO" ? `‚úÖ Env√≠o pagado` : `‚è≥ Env√≠o pendiente de pago`);
  return lines.join("\n");
}

function renderShipmentDetail(sh){
  const isShip = true;
  document.documentElement.style.setProperty("--shipReceiptW", `${Math.max(240, Number(state.settings.shipReceiptW||360))}px`);
  $("shipReceiptBox").classList.add("ship");

  $("srShop").textContent = sh.shop || state.settings.shopName || "Tienda de Ropa";
  $("srMeta").textContent = `Env√≠o ‚Ä¢ ${sh.status} ‚Ä¢ ${sh.payMethod||""}`;
  $("srNo").textContent = "#" + (sh.shipNo || "ENV-??????");
  $("srDate").textContent = new Date(sh.ts || Date.now()).toLocaleString();

  const client = sh.client ? `${sh.client.names} ${sh.client.last}` : "‚Äî";
  $("srClient").textContent = client;
  $("srPhone").textContent = sh.client?.phone || "‚Äî";
  $("srAddr").textContent  = sh.client?.addr || "‚Äî";
  $("srPay").textContent   = sh.payMethod || "‚Äî";

  const itemsDiv = $("srItems");
  itemsDiv.innerHTML = "";
  for(const it of (sh.items||[])){
    const line = document.createElement("div");
    line.className="line";
    line.innerHTML = `<span>${it.qty} x ${escapeHtml(it.name)}</span><span>${money(it.qty*it.price)}</span>`;
    itemsDiv.appendChild(line);
  }

  $("srSub").textContent = money(sh.subtotal ?? 0);
  $("srDisc").textContent = money(sh.discountAmount ?? 0);
  $("srTotal").textContent = money(sh.total ?? 0);
  $("srFoot").textContent = sh.status==="PAGADO" ? "Env√≠o pagado ‚úÖ" : "Env√≠o en espera ‚è≥";
}

async function selectShipment(id){
  const sh = await idbGet("shipments", id);
  if(!sh) return alert("Env√≠o no encontrado.");
  state.selectedShipment = sh;
  renderShipmentDetail(sh);
}

async function markShipmentPaid(id){
  if(!requireCode("marcar env√≠o como pagado")) return;
  const sh = await idbGet("shipments", id);
  if(!sh) return alert("Env√≠o no encontrado.");
  if(sh.status==="PAGADO") return alert("Este env√≠o ya est√° pagado.");

  // validar stock al momento de pago
  try{
    await validateAndDeductStock(sh.items||[]);
  }catch(err){
    return alert(String(err.message||err));
  }

  // crear venta
  const paidAt = Date.now();
  const receiptNo = await nextReceiptNo();
  const sale = {
    id: "S-" + paidAt + "-" + Math.random().toString(16).slice(2,8),
    ts: paidAt,
    dateKey: todayKey(paidAt),
    weekKey: weekKey(paidAt),
    monthKey: monthKey(paidAt),
    saleType: "ENVIO",
    payMethod: sh.payMethod,
    client: sh.client,
    items: (sh.items||[]).map(x=>({...x})),
    subtotal: Number(sh.subtotal||0),
    discountType: sh.discountType,
    discountValue: Number(sh.discountValue||0),
    discountAmount: Number(sh.discountAmount||0),
    total: Number(sh.total||0),
    receiptNo: pad(receiptNo, 6),
    shop: sh.shop || state.settings.shopName,
    linkShipmentId: sh.id
  };
  await idbPut("sales", sale);

  sh.status = "PAGADO";
  sh.paidAt = paidAt;
  sh.saleId = sale.id;
  await idbPut("shipments", sh);

  state.lastReceipt = sale;
  await refreshKPIs();
  await renderShipments();
  refreshProductPicker();
  renderInventory();
  updateReceiptPreview();

  alert("Env√≠o marcado como PAGADO ‚úÖ (se registr√≥ venta y se descont√≥ stock).");
}

// Export para env√≠o seleccionado (texto/wa/pdf/png)
async function shipCopy(){
  const sh = state.selectedShipment;
  if(!sh) return alert("Selecciona un env√≠o.");
  const text = shipmentToText(sh);
  try{ await navigator.clipboard.writeText(text); alert("Env√≠o copiado."); }
  catch{ alert("No se pudo copiar autom√°ticamente."); }
}
function shipWA(){
  const sh = state.selectedShipment;
  if(!sh) return alert("Selecciona un env√≠o.");
  window.open("https://wa.me/?text="+encodeURIComponent(shipmentToText(sh)), "_blank");
}
function shipPDF(){
  const sh = state.selectedShipment;
  if(!sh) return alert("Selecciona un env√≠o.");
  // Reutilizamos el mismo HTML de recibo, pero pasando como "sale-like"
  const pseudoSale = {
    ts: sh.ts,
    receiptNo: sh.shipNo,
    saleType: "ENVIO",
    payMethod: sh.payMethod,
    client: sh.client,
    items: sh.items,
    subtotal: sh.subtotal,
    discountAmount: sh.discountAmount,
    total: sh.total,
    shop: sh.shop
  };
  const html = receiptToPrintableHTML(pseudoSale);
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para PDF.");
  w.document.open();
  w.document.write(html);
  w.document.close();
}
async function shipPNG(){
  const sh = state.selectedShipment;
  if(!sh) return alert("Selecciona un env√≠o.");
  const node = $("shipReceiptBox");
  if(!node) return;
  const scale = Number(state.settings.shipPngScale||2);
  try{
    await capturePNG(node, `envio_${(sh.shipNo||"----")}.png`, scale);
  }catch(e){
    alert("No se pudo generar PNG. Intenta con PDF.");
  }
}

// ---------- Cierre (por rango) ----------
function closeToText(c){
  if(!c) return "No hay cierre todav√≠a.";
  const lines = [];
  lines.push(`üßæ *${c.shop}*`);
  lines.push(`CIERRE DE VENTAS ‚Äî ${c.dateKey}`);
  if(c.name) lines.push(`Turno: ${c.name}`);
  lines.push(`Rango: ${c.rangeLabel}`);
  lines.push(`Generado: ${new Date(c.ts).toLocaleString()}`);
  lines.push(`--------------------------------`);
  lines.push(`Ventas: ${c.salesCount}`);
  lines.push(`Mostrador: ${c.mostradorCount} | Env√≠os pagados: ${c.envioCount}`);
  lines.push(`--------------------------------`);
  lines.push(`EFECTIVO: ${money(c.pay.EFECTIVO)}`);
  lines.push(`TARJETA: ${money(c.pay.TARJETA)}`);
  lines.push(`TRANSFERENCIA: ${money(c.pay.TRANSFERENCIA)}`);
  lines.push(`--------------------------------`);
  lines.push(`SUBTOTAL: ${money(c.subtotal)}`);
  lines.push(`DESCUENTOS: ${money(c.discounts)}`);
  lines.push(`TOTAL: *${money(c.total)}*`);
  lines.push(`--------------------------------`);
  lines.push(`CUADRE (Contado vs Sistema)`);
  lines.push(`Contado: ${money(c.countedTotal)}`);
  lines.push(`Diferencia: ${money(c.diffTotal)}`);
  lines.push(`--------------------------------`);
  lines.push(`Productos vendidos:`);
  for(const p of c.products){
    lines.push(`- ${p.qty} x ${p.name} (${p.code})`);
  }
  lines.push(`--------------------------------`);
  lines.push(`Cierre generado ‚úÖ`);
  return lines.join("\n");
}

function closeToPrintableHTML(c){
  const rows = c.products.map(p=>`
    <tr>
      <td style="text-align:center">${p.qty}</td>
      <td>${escapeHtml(p.name)}<br><small>${escapeHtml(p.code)}</small></td>
    </tr>
  `).join("");

  return `
  <!doctype html>
  <html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Cierre ${escapeHtml(c.dateKey)}</title>
    <style>
      body{ font-family: Arial, sans-serif; margin: 20px; color:#111; background:#fff7fb; }
      .box{ position:relative; max-width: 860px; margin: 0 auto; border:2px solid #fbcfe8; border-radius:16px; padding:16px; background:#fff; }
      .cornerLogo{ position:absolute; top:12px; right:12px; width:60px; height:60px; object-fit:contain; border-radius:14px; border:1px solid #eee; padding:4px; background:#fff; }
      .bar{ height:8px; border-radius:999px; background: linear-gradient(90deg, #ff4fb7, #a855f7); margin-bottom:12px; }
      h1{ margin:0; font-size:18px; color:#7b2fb4; padding-right:70px; }
      .meta{ margin-top:4px; color:#444; font-size:12px; font-weight:700; }
      .line{ display:flex; justify-content:space-between; gap:12px; font-weight:800; margin:6px 0; }
      table{ width:100%; border-collapse:collapse; margin-top:14px; }
      th,td{ border-bottom:1px solid #eee; padding:8px; font-size:13px; }
      th{ background:#ffe4f1; text-align:left; }
      @media print{
        body{ margin:0; }
        .box{ border:none; border-radius:0; }
      }
    </style>
  </head>
  <body onload="setTimeout(function(){window.print();},250)">
    <div class="box">
      <img class="cornerLogo" src="LOGO1.png" alt="Logo" />
      <div class="bar"></div>
      <h1>${escapeHtml(c.shop)} ‚Äî Cierre ${escapeHtml(c.dateKey)}</h1>
      <div class="meta">Rango: ${escapeHtml(c.rangeLabel)}${c.name ? " ‚Ä¢ Turno: "+escapeHtml(c.name) : ""} ‚Ä¢ Generado: ${escapeHtml(new Date(c.ts).toLocaleString())}</div>

      <div class="line"><span>Ventas</span><span>${c.salesCount}</span></div>
      <div class="line"><span>Mostrador</span><span>${c.mostradorCount}</span></div>
      <div class="line"><span>Env√≠os pagados</span><span>${c.envioCount}</span></div>
      <hr>

      <div class="line"><span>EFECTIVO</span><span>${money(c.pay.EFECTIVO)}</span></div>
      <div class="line"><span>TARJETA</span><span>${money(c.pay.TARJETA)}</span></div>
      <div class="line"><span>TRANSFERENCIA</span><span>${money(c.pay.TRANSFERENCIA)}</span></div>
      <hr>

      <div class="line"><span>SUBTOTAL</span><span>${money(c.subtotal)}</span></div>
      <div class="line"><span>DESCUENTOS</span><span>${money(c.discounts)}</span></div>
      <div class="line"><span>TOTAL</span><span>${money(c.total)}</span></div>
      <hr>

      <div class="line"><span>Contado</span><span>${money(c.countedTotal)}</span></div>
      <div class="line"><span>Diferencia</span><span>${money(c.diffTotal)}</span></div>

      <h3 style="margin-top:14px">Productos vendidos</h3>
      <table>
        <thead><tr><th style="width:80px;text-align:center">Cant</th><th>Producto</th></tr></thead>
        <tbody>${rows || `<tr><td colspan="2">Sin ventas</td></tr>`}</tbody>
      </table>

      <div style="margin-top:12px; color:#444; font-size:12px; font-weight:700;">Cierre generado ‚úÖ</div>
    </div>
  </body>
  </html>
  `;
}

async function buildClose(){
  const dateKey = $("closeDate").value || todayKey();
  const startTime = $("closeStart").value || "00:00";
  const endTime = $("closeEnd").value || "23:59";

  const startTs = parseDateTime(dateKey, startTime);
  const endTs = parseDateTime(dateKey, endTime) + 59*1000; // incluye el minuto final

  const all = await idbAll("sales");
  const list = all
    .filter(s => s.ts>=startTs && s.ts<=endTs)
    .sort((a,b)=>a.ts-b.ts);

  const pay = {EFECTIVO:0, TARJETA:0, TRANSFERENCIA:0};
  let subtotal = 0;
  let discounts = 0;
  let total = 0;
  let envioCount = 0;
  let mostradorCount = 0;

  const prodMap = new Map();

  for(const s of list){
    subtotal += Number(s.subtotal ?? s.total ?? 0);
    discounts += Number(s.discountAmount ?? 0);
    total += Number(s.total ?? 0);

    if(s.saleType==="ENVIO") envioCount++; else mostradorCount++;

    pay[s.payMethod] = (pay[s.payMethod]||0) + Number(s.total||0);

    for(const it of (s.items||[])){
      const key = it.code;
      const cur = prodMap.get(key) || {code:it.code, name:it.name, qty:0};
      cur.qty += Number(it.qty||0);
      cur.name = it.name;
      prodMap.set(key, cur);
    }
  }

  const products = [...prodMap.values()].sort((a,b)=>b.qty-a.qty);

  const hb = $("closeHistBody");
  hb.innerHTML = "";
  for(const s of list){
    const tr = document.createElement("tr");
    const d = new Date(s.ts);
    const when = d.toLocaleTimeString();
    const client = s.client ? `${s.client.names} ${s.client.last}` : "MOSTRADOR";
    tr.innerHTML = `
      <td><small>${escapeHtml(when)}</small><br><small>#${escapeHtml(s.receiptNo||"")}</small></td>
      <td>${escapeHtml(client)}</td>
      <td>${escapeHtml(s.saleType||"")}</td>
      <td>${escapeHtml(s.payMethod||"")}</td>
      <td>${money(s.total||0)}</td>
    `;
    hb.appendChild(tr);
  }

  // cuadre
  const counted = {
    EFECTIVO: Number($("countCash").value||0),
    TARJETA: Number($("countCard").value||0),
    TRANSFERENCIA: Number($("countTrans").value||0)
  };
  const sysTotal = Number(pay.EFECTIVO||0) + Number(pay.TARJETA||0) + Number(pay.TRANSFERENCIA||0);
  const countedTotal = Number(counted.EFECTIVO||0) + Number(counted.TARJETA||0) + Number(counted.TRANSFERENCIA||0);
  const diffTotal = Number((countedTotal - sysTotal).toFixed(2));

  const close = {
    id: "C-" + Date.now() + "-" + Math.random().toString(16).slice(2,8),
    ts: Date.now(),
    dateKey,
    name: $("closeName").value.trim() || "",
    startTime, endTime,
    rangeLabel: fmtRange(dateKey, startTime, endTime),
    startTs, endTs,
    shop: state.settings.shopName || "Tienda de Ropa",
    salesCount: list.length,
    envioCount,
    mostradorCount,
    pay,
    subtotal: Number(subtotal.toFixed(2)),
    discounts: Number(discounts.toFixed(2)),
    total: Number(total.toFixed(2)),
    products,
    counted,
    countedTotal: Number(countedTotal.toFixed(2)),
    diffTotal
  };

  state.lastClose = close;

  $("cShop").textContent = close.shop;
  $("cMeta").textContent = "Cierre ‚Ä¢ Turno";
  $("cDate").textContent = close.dateKey;
  $("cTime").textContent = new Date(close.ts).toLocaleString();
  $("cRange").textContent = `${startTime} - ${endTime}`;

  $("cSales").textContent = String(close.salesCount);
  $("cMost").textContent = String(close.mostradorCount);
  $("cEnv").textContent = String(close.envioCount);

  $("cCash").textContent = money(close.pay.EFECTIVO||0);
  $("cCard").textContent = money(close.pay.TARJETA||0);
  $("cTrans").textContent = money(close.pay.TRANSFERENCIA||0);

  $("cSub").textContent = money(close.subtotal);
  $("cDisc").textContent = money(close.discounts);
  $("cTotal").textContent = money(close.total);

  $("cCounted").textContent = money(close.countedTotal);
  $("cDiff").textContent = money(close.diffTotal);

  const cp = $("cProducts");
  cp.innerHTML = "";
  if(close.products.length===0){
    const div = document.createElement("div");
    div.className="muted";
    div.textContent = "Sin ventas en este rango.";
    cp.appendChild(div);
  }else{
    for(const p of close.products.slice(0,50)){
      const div = document.createElement("div");
      div.className="line";
      div.innerHTML = `<span>${p.qty} x ${escapeHtml(p.name)}</span><span><small>${escapeHtml(p.code)}</small></span>`;
      cp.appendChild(div);
    }
  }
}

async function saveClose(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  if(!requireCode("guardar cierre")) return;
  await idbPut("closes", state.lastClose);
  alert("Cierre guardado ‚úÖ");
  await renderCloseList();
}

async function renderCloseList(){
  const dateKey = $("closeDate").value || todayKey();
  const all = await idbAll("closes");
  const list = all.filter(c=>c.dateKey===dateKey).sort((a,b)=>b.ts-a.ts);

  const tb = $("closeListBody");
  tb.innerHTML = "";
  for(const c of list){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><small>${escapeHtml(c.rangeLabel||"")}</small></td>
      <td>${escapeHtml(c.name||"‚Äî")}</td>
      <td>${money(c.total||0)}</td>
      <td>
        <button class="btn small" data-closeview="${escapeHtml(c.id)}">Ver</button>
        <button class="btn danger small" data-closedel="${escapeHtml(c.id)}">Borrar</button>
      </td>
    `;
    tb.appendChild(tr);
  }
}

async function loadClose(id){
  const c = await idbGet("closes", id);
  if(!c) return alert("Cierre no encontrado.");
  state.lastClose = c;

  $("closeDate").value = c.dateKey;
  $("closeName").value = c.name||"";
  $("closeStart").value = c.startTime||"00:00";
  $("closeEnd").value = c.endTime||"23:59";
  $("countCash").value = c.counted?.EFECTIVO ?? 0;
  $("countCard").value = c.counted?.TARJETA ?? 0;
  $("countTrans").value = c.counted?.TRANSFERENCIA ?? 0;

  await buildClose(); // recalcula tabla seg√∫n rango actual
  // luego reemplaza ticket con datos guardados (incluye diffs originales)
  state.lastClose = c;
  $("cRange").textContent = `${c.startTime||"00:00"} - ${c.endTime||"23:59"}`;
  $("cCounted").textContent = money(c.countedTotal||0);
  $("cDiff").textContent = money(c.diffTotal||0);
}

async function deleteClose(id){
  if(!requireCode("borrar cierre")) return;
  if(!confirm("¬øBorrar este cierre guardado?")) return;
  await idbDel("closes", id);
  await renderCloseList();
  alert("Cierre borrado.");
}

async function copyClose(){
  const text = closeToText(state.lastClose);
  try{
    await navigator.clipboard.writeText(text);
    alert("Cierre copiado.");
  }catch{
    alert("No se pudo copiar autom√°ticamente.");
  }
}
function openCloseWhatsApp(){
  const text = closeToText(state.lastClose);
  window.open("https://wa.me/?text=" + encodeURIComponent(text), "_blank");
}
function generateClosePDF(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  const html = closeToPrintableHTML(state.lastClose);
  const w = window.open("", "_blank");
  if(!w) return alert("Tu navegador bloque√≥ la ventana emergente. Permite popups para PDF.");
  w.document.open();
  w.document.write(html);
  w.document.close();
}
async function downloadClosePNG(){
  if(!state.lastClose) return alert("Primero genera el cierre.");
  const node = $("closeBox");
  if(!node) return;

  if(window.html2canvas){
    try{
      await capturePNG(node, `cierre_${state.lastClose.dateKey}_${(state.lastClose.startTime||"00-00")}.png`, 2);
      return;
    }catch(e){
      // sigue al aviso abajo
    }
  }
  alert("No se pudo generar PNG. Intenta con PDF.");
}

// ---------- Backup / Restore / Settings / KPIs ----------
async function exportJSON(){
  const clients = await idbAll("clients");
  const products= await idbAll("products");
  const sales   = await idbAll("sales");
  const meta    = await idbAll("meta");
  const shipments = await idbAll("shipments");
  const closes = await idbAll("closes");

  const data = {
    exportedAt: new Date().toISOString(),
    settings: state.settings,
    clients, products, sales, shipments, closes, meta
  };
  const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download =
